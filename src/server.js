require('dotenv').config({ path: require('path').join(__dirname, '../config/.env') });
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const path = require('path');
const { OpenAI } = require('openai');

// Configura√ß√£o OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Importar agentes especializados
const resultadosAgent = require('./agents/resultadosAgent');
const classificacoesAgent = require('./agents/classificacoesAgent');
const jogadoresAgent = require('./agents/jogadoresAgent');
const livrosAgent = require('./agents/livrosAgent');
const biografiasAgent = require('./agents/biografiasAgent');
const presidentesAgent = require('./agents/presidentesAgent');
const fundacaoAgent = require('./agents/fundacaoAgent');
const epocaDetalhadaAgent = require('./agents/epocaDetalhadaAgent');

const app = express();
app.use(bodyParser.json());
app.use(cors());

// Servir ficheiros est√°ticos da pasta public
app.use(express.static(path.join(__dirname, '../public')));

// Fun√ß√£o para determinar qual agente usar
function getAgentByTopic(userMessage) {
  const lowerMsg = userMessage.toLowerCase();
  
  // Resultados (incluir mais palavras-chave e padr√µes de √©poca)
  if (lowerMsg.includes('resultado') || lowerMsg.includes('jogo') || lowerMsg.includes('partida') ||
      lowerMsg.includes('venceu') || lowerMsg.includes('perdeu') || lowerMsg.includes('empatou') ||
      lowerMsg.includes('marcador') || lowerMsg.includes('golo') || lowerMsg.includes('ta√ßa') ||
      lowerMsg.includes('copa') || lowerMsg.includes('uefa') || lowerMsg.includes('europa') ||
      lowerMsg.includes('final') || lowerMsg.includes('eliminat√≥ria') || lowerMsg.includes('meia') ||
      // Detectar padr√µes de √©poca (89/90, 1989/90, 1989-90, etc)
      /\d{2}\/\d{2}|\d{4}\/\d{2,4}|\d{4}-\d{2,4}/.test(lowerMsg)) {
    return resultadosAgent;
  }
  
  // Classifica√ß√µes (adicionar "√©poca" e padr√µes temporais)
  if (lowerMsg.includes('classifica') || lowerMsg.includes('tabela') || lowerMsg.includes('posi√ß√£o') ||
      lowerMsg.includes('pontos') || lowerMsg.includes('liga') || lowerMsg.includes('divis√£o') ||
      lowerMsg.includes('campeonato') || lowerMsg.includes('√©poca') || lowerMsg.includes('temporada') ||
      lowerMsg.includes('campe√£o') || lowerMsg.includes('desceu') || lowerMsg.includes('subiu')) {
    return classificacoesAgent;
  }
  
  // Jogadores
  if (lowerMsg.includes('jogador') || lowerMsg.includes('plantel') || lowerMsg.includes('equipa') || 
      lowerMsg.includes('guarda-redes') || lowerMsg.includes('defesa') || lowerMsg.includes('m√©dio') || 
      lowerMsg.includes('avan√ßado') || lowerMsg.includes('capit√£o') || lowerMsg.includes('goleador')) {
    return jogadoresAgent;
  }
  
  // Livros
  if (lowerMsg.includes('livro') || lowerMsg.includes('obra') || lowerMsg.includes('publica√ß√£o') || 
      lowerMsg.includes('autor') || lowerMsg.includes('leitura') || lowerMsg.includes('escrito')) {
    return livrosAgent;
  }
  
  // Biografias
  if (lowerMsg.includes('biografia') || lowerMsg.includes('vida') || lowerMsg.includes('carreira') || 
      lowerMsg.includes('hassan') || lowerMsg.includes('nader') || 
      lowerMsg.includes('paco fortes') || lowerMsg.includes('fortes') || 
      lowerMsg.includes('jorge soares') || lowerMsg.includes('soares') || 
      lowerMsg.includes('manuel jos√©') || lowerMsg.includes('jo√£o gralho') || 
      lowerMsg.includes('gralho') || lowerMsg.includes('ant√≥nio gago') || 
      lowerMsg.includes('gago') || lowerMsg.includes('quem foi') || 
      lowerMsg.includes('quem √©') || lowerMsg.includes('jogador hist√≥rico') || 
      lowerMsg.includes('treinador hist√≥rico') || lowerMsg.includes('√≠dolo')) {
    return biografiasAgent;
  }
  
  // Presidentes
  if (lowerMsg.includes('presidente') || lowerMsg.includes('dire√ß√£o') || lowerMsg.includes('dirigente') || 
      lowerMsg.includes('mandato') || lowerMsg.includes('lideran√ßa') || lowerMsg.includes('gest√£o')) {
    return presidentesAgent;
  }
  
  // Funda√ß√£o e Hist√≥ria
  if (lowerMsg.includes('funda√ß√£o') || lowerMsg.includes('hist√≥ria') || lowerMsg.includes('origem') || 
      lowerMsg.includes('cria√ß√£o') || lowerMsg.includes('in√≠cio') || lowerMsg.includes('fundador') || 
      lowerMsg.includes('1910') || lowerMsg.includes('primeiro') || lowerMsg.includes('come√ßo') ||
      lowerMsg.includes('nascimento') || lowerMsg.includes('surgiu') || lowerMsg.includes('surgimento')) {
    return fundacaoAgent;
  }
  
  // Se n√£o encontrar um t√≥pico espec√≠fico, retorna null
  return null;
}

app.post('/api/chat', async (req, res) => {
  try {
    const userMessage = req.body.message || '';
    const lowerMsg = userMessage.toLowerCase();

    // DETEC√á√ÉO AUTOM√ÅTICA DE √âPOCA: Padr√µes como 1990/91, 90/91, 1990-91, etc.
    const epocaMatch = userMessage.match(/\b(\d{2,4})[\/-](\d{2,4})\b/);
    if (epocaMatch) {
      console.log('[DEBUG] Detectada query de √©poca:', epocaMatch[0]);
      const relatorioEpoca = epocaDetalhadaAgent.getEpocaDetalhada(epocaMatch[0]);
      if (relatorioEpoca) {
        console.log('[DEBUG] Relat√≥rio de √©poca gerado com sucesso');
        return res.json({ reply: relatorioEpoca });
      }
      // Se n√£o encontrou dados, continua para o fluxo normal
      console.log('[DEBUG] Nenhum dado encontrado para √©poca:', epocaMatch[0]);
    }

    // CASO ESPECIAL: Perguntas sobre √©poca 1989/90 - GPT-3.5 tem dificuldade em encontrar
    if ((lowerMsg.includes('1989') || lowerMsg.includes('89')) &&
        (lowerMsg.includes('/90') || lowerMsg.includes('90'))) {
      const response1989 = `A √©poca 1989/1990 foi hist√≥rica para os Le√µes de Faro! üèÜ

O Farense jogou na **II Divis√£o** (segundo escal√£o) e teve uma temporada fant√°stica:

**Campeonato:**
- üèÜ **1¬∫ LUGAR - CAMPE√ÉO da II Divis√£o Zona Sul**
- **55 pontos** em 34 jogos
- 25 vit√≥rias, 5 empates, 4 derrotas
- 80 golos marcados, 23 sofridos
- ‚¨ÜÔ∏è **PROMO√á√ÉO garantida √† I Divis√£o**

**Ta√ßa de Portugal:**
- ü•à **FINALISTA** (perdeu 2-0 vs Estrela da Amadora)
- Melhor participa√ß√£o de sempre na Ta√ßa!

Foi uma √©poca hist√≥rica: campe√µes da II Divis√£o e finalistas da Ta√ßa de Portugal, regressando ao escal√£o principal do futebol portugu√™s! ‚öΩ`;

      return res.json({ reply: response1989 });
    }

    // Base prompt EXTREMAMENTE RESTRITIVO - NUNCA INVENTAR
    let systemPrompt = `√âs um assistente virtual especializado no Sporting Clube Farense.

REGRAS ABSOLUTAS E INVIOL√ÅVEIS:
1. NUNCA inventes informa√ß√£o. ZERO toler√¢ncia para inven√ß√µes.
2. USA EXCLUSIVAMENTE os dados fornecidos no contexto abaixo.
3. Se n√£o tiveres dados EXACTOS sobre algo, diz "N√£o tenho informa√ß√£o dispon√≠vel sobre [tema espec√≠fico]".
4. NUNCA fa√ßas suposi√ß√µes ou infer√™ncias sobre √©pocas, resultados ou classifica√ß√µes.
5. Se te perguntarem sobre uma √©poca espec√≠fica e n√£o tiveres dados dessa √©poca, diz claramente que n√£o tens.
6. NUNCA confundas √©pocas diferentes - cada √©poca tem dados √∫nicos.
7. Se s√≥ tens dados de uma competi√ß√£o (ex: Ta√ßa), n√£o fales sobre outras (ex: Campeonato) dessa √©poca.

FORMATA√á√ÉO:
- Usa Markdown para formatar as respostas (negrito **texto**, listas, t√≠tulos, etc.)
- Usa emojis relevantes (üèÜ para t√≠tulos, ‚öΩ para golos, ü¶Å para o Farense, etc.)
- Estrutura bem a informa√ß√£o com listas e par√°grafos
- Usa **negrito** para destacar n√∫meros importantes e nomes

Responde sempre em portugu√™s de Portugal, de forma simp√°tica mas SEMPRE baseada em factos do contexto.`;

    // Verificar se h√° um agente especializado para este tema
    const agent = getAgentByTopic(userMessage);
    if (agent) {
      // Adicionar contexto do agente especializado
      systemPrompt += '\n\n' + agent.context;

      // Se for o agente de biografias, fazer busca din√¢mica
      if (agent === biografiasAgent && biografiasAgent.searchBiografias) {
        // Extrair nome da mensagem removendo palavras comuns de pergunta
        const cleanQuery = userMessage
          .replace(/quem (foi|√©|era)/gi, '')
          .replace(/fala(-me| me)? sobre/gi, '')
          .replace(/quero saber sobre/gi, '')
          .replace(/conta(-me| me)? (sobre|de|da)?/gi, '')
          .replace(/biografia de/gi, '')
          .replace(/historia de/gi, '')
          .replace(/hist√≥ria de/gi, '')
          .replace(/informa√ß√£o sobre/gi, '')
          .replace(/info sobre/gi, '')
          .replace(/detalhes sobre/gi, '')
          .replace(/[?!.]/g, '')
          .trim();

        console.log('[DEBUG] Fazendo busca de biografias para:', cleanQuery);
        const searchResults = biografiasAgent.searchBiografias(cleanQuery);
        console.log('[DEBUG] Resultados encontrados:', searchResults.length);

        if (searchResults.length > 0) {
          console.log('[DEBUG] Primeira biografia:', searchResults[0].file);
          // RETORNAR DIRETAMENTE O MARKDOWN COMPLETO DA BIOGRAFIA
          // Sem passar pelo GPT - resposta instant√¢nea com todo o conte√∫do
          const biografiaCompleta = searchResults[0].content;
          return res.json({ reply: biografiaCompleta });
        }
      }

      // Adicionar lembrete final
      systemPrompt += '\n\nLEMBRETE FINAL: Usa APENAS a informa√ß√£o acima. Se algo n√£o est√° explicitamente mencionado, n√£o inventes!';
    }

    console.log('[DEBUG] Tamanho do system prompt:', systemPrompt.length, 'caracteres');

    // Chamar a API da OpenAI com temperatura BAIXA para evitar criatividade
    const response = await openai.chat.completions.create({
      model: 'gpt-4o-mini', // Modelo mais avan√ßado e capaz
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userMessage }
      ],
      temperature: 0.1, // MUITO baixo - foco em factos
      max_tokens: 1000, // Aumentado para permitir respostas mais detalhadas
      top_p: 0.3, // Adicionar para maior determinismo
      frequency_penalty: 0.5, // Penalizar repeti√ß√µes
      presence_penalty: 0.3 // Encorajar diversidade mas com cautela
    });

    const chatbotReply = response.choices[0].message.content;
    res.json({ reply: chatbotReply });
  } catch (error) {
    console.error('Erro ao processar a mensagem:', error);
    
    // Verificar se a pergunta √© sobre Paco Fortes
    const lowerMsg = req.body.message.toLowerCase();
    if (lowerMsg.includes('paco') || lowerMsg.includes('fortes')) {
      // Resposta de fallback para Paco Fortes
      const fallbackReply = "Paco Fortes foi um importante jogador e treinador do Sporting Clube Farense. Como treinador, levou os Le√µes de Faro √† sua melhor classifica√ß√£o de sempre (5¬∫ lugar) na temporada 1994/95, qualificando o clube para a Ta√ßa UEFA pela primeira vez na sua hist√≥ria. Nascido em Barcelona, √© considerado 'o catal√£o mais farense de que h√° mem√≥ria'.";
      return res.json({ reply: fallbackReply });
    }
    
    // Resposta de erro gen√©rica
    res.status(500).json({ 
      error: 'Ocorreu um erro ao processar a tua mensagem. Por favor, tenta novamente mais tarde.',
      details: error.message 
    });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Servidor a correr na porta ${PORT}`);
}); 